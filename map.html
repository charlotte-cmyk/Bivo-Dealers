<body>
  <title>Shops Map with Custom Pins and Labels</title>
  <style>
    #map {
      height: 600px;
      width: 100%;
    }
  </style>
  <script>
    function initMap() {
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 4,
        center: { lat: 39.8283, lng: -98.5795 }
      });

      const service = new google.maps.places.PlacesService(map);

      const kmlUrl = "https://raw.githubusercontent.com/charlotte-cmyk/Bivo-Dealers/refs/heads/main/all_dealers.kml";

      fetch(kmlUrl)
        .then(response => response.text())
        .then(kmlText => {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(kmlText, "application/xml");
          const placemarks = xmlDoc.getElementsByTagName("Placemark");

          for (let i = 0; i < placemarks.length; i++) {
            const placemark = placemarks[i];
            const name = placemark.getElementsByTagName("name")[0]?.textContent || "Unnamed";
            const coordsText = placemark.getElementsByTagName("coordinates")[0]?.textContent.trim();

            if (!coordsText) continue;

            const coords = coordsText.split(",");
            const lat = parseFloat(coords[1]);
            const lng = parseFloat(coords[0]);

            const customIcon = {
              url: "https://raw.githubusercontent.com/charlotte-cmyk/Bivo-Dealers/main/Bivo-Dealer-Icon%20copy.png",
              scaledSize: new google.maps.Size(24, 33)
            };

            const marker = new google.maps.Marker({
              position: { lat, lng },
              map: map,
              title: name,
              icon: customIcon,
            });

            const request = {
              query: name,
              location: marker.position,
              radius: 500
            };

            service.textSearch(request, (results, status) => {
              if (status === google.maps.places.PlacesServiceStatus.OK && results[0]) {
                const place = results[0];
                const placeId = place.place_id;

                // Now get full details
                service.getDetails({
                  placeId: placeId,
                  fields: ["name", "formatted_address", "rating", "website", "photos"]
                }, (detailedPlace, detailStatus) => {
                  let infoContent;
                  if (detailStatus === google.maps.places.PlacesServiceStatus.OK) {
                    const photoUrl = detailedPlace.photos?.[0]?.getUrl({ maxWidth: 200 }) || '';

                    infoContent = `
                      <div style=color: #75ccf0; width: 100%; height: 100%; padding: 10px; border-radius: 8px; box-sizing: border-box; font-family: Arial, sans-serif; font-size: 13px; color: #22336e;">
                        <div style="display: flex;">
                          ${photoUrl ? `<img src="${photoUrl}" alt="${detailedPlace.name}" style="width: 80px; height: 80px; object-fit: cover; margin-right: 10px; border-radius: 4px;">` : ''}
                          <div>
                            <strong style="font-size: 14px; font-weight: bold; color: #263a79;">${detailedPlace.name}</strong><br>
                            ${detailedPlace.formatted_address || ''}<br>
                            ${detailedPlace.rating ? `‚≠ê ${detailedPlace.rating} / 5<br>` : ''}
                            ${detailedPlace.website ? `<a href="${detailedPlace.website}" target="_blank" style="color: #003366; text-decoration: underline;">Website</a>` : ''}
                          </div>
                        </div>
                      </div>
                    `;
                  } else {
                    infoContent = `<strong>${name}</strong>`;
                  }

                  const infoWindow = new google.maps.InfoWindow({ content: infoContent });
                  let isSticky = false;

                  marker.addListener("mouseover", () => {
                    if (!isSticky) {
                      infoWindow.setContent(infoContent);
                      infoWindow.open(map, marker);
                    }
                  });

                  marker.addListener("mouseout", () => {
                    if (!isSticky) {
                      infoWindow.close();
                    }
                  });

                  marker.addListener("click", () => {
                    if (isSticky && infoWindow.anchor === marker) {
                      infoWindow.close();
                      isSticky = false;
                    } else {
                      infoWindow.setContent(infoContent);
                      infoWindow.open(map, marker);
                      isSticky = true;
                    }
                  });
                });

              } else {
                // No match found in Places API, fallback info
                const infoWindow = new google.maps.InfoWindow({
                  content: `<strong>${name}</strong>`
                });

                let isSticky = false;

                marker.addListener("mouseover", () => {
                  if (!isSticky) {
                    infoWindow.open(map, marker);
                  }
                });

                marker.addListener("mouseout", () => {
                  if (!isSticky) {
                    infoWindow.close();
                  }
                });

                marker.addListener("click", () => {
                  if (isSticky && infoWindow.anchor === marker) {
                    infoWindow.close();
                    isSticky = false;
                  } else {
                    infoWindow.open(map, marker);
                    isSticky = true;
                  }
                });
              }
            });
          }
        })
        .catch(err => console.error("Failed to fetch KML:", err));
    }
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAvj_ZEQfd7wBcdY_wdzMdxM2aTZaBEVZo&libraries=places&callback=initMap" async defer></script>

  <h2>Shops Map with Custom Pins and Labels</h2>
  <div id="map"></div>
</body>
