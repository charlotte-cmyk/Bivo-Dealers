<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Bivo Dealers Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet" />
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
      .mapboxgl-popup-content {
        background: #103059;
        color: #41D2FA;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
      }
      .mapboxgl-popup-tip {
        border-top-color: #103059 !important;
      }
      .mapboxgl-popup-content h3 {
        margin: 0 0 5px;
        color: #ffffff;
      }
      .mapboxgl-popup-content a {
        color: gold;
        text-decoration: none;
      }
      .mapboxgl-popup-content a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      // ====== GLOBAL SETTINGS YOU CAN ADJUST ======
      const MAP_CENTER_DISPLAY_COORD = [-106.5348, 38.7946]; // Default: near center of USA
      const MAP_ZOOM_LEVEL = 2.4; // Adjust for desired zoom
      // =============================================

      mapboxgl.accessToken = 'pk.eyJ1IjoiYW5kcmV3c3ViaWUiLCJhIjoiY21oM3ZxNHlyMGNqbTJwcTBrNmxneDd1diJ9._7vjHoFAmx1Ds2zOhXktMQ';

      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/andrewsubie/cmh9fhjp3001k01qr57ai1k7r',
        center: MAP_CENTER_DISPLAY_COORD,
        zoom: MAP_ZOOM_LEVEL
      });

      map.on('click', (event) => {
        const features = map.queryRenderedFeatures(event.point, {
          layers: ['bivo-dealers-unique', 'bivo-rei', 'bivo-roamer'] // your actual layer name in Mapbox Studio
        });
        if (!features.length) return;

        const feature = features[0];
        if (window.activeDealerPopup) window.activeDealerPopup.remove();

        const [lng, lat] = feature.geometry.coordinates;
        let website = feature.properties.Website;
        if (website && !/^https?:\/\//i.test(website)) website = 'https://' + website;

        const name = feature.properties.name || 'Unnamed Dealer';
        const city = feature.properties.City || '';
        const state = feature.properties.State || '';
        const zip = (feature.properties.Zip || feature.properties['Zip Code'] || '').trim();
        const websiteLink = website
          ? `<a href="${website}" target="_blank" rel="noopener noreferrer">${website}</a>`
          : '';

        const popup = new mapboxgl.Popup({ offset: [0, -15] }).setLngLat([lng, lat]);
        window.activeDealerPopup = popup;

        if (feature.properties.Address) {
          popup
            .setHTML(`<h3>${name}</h3><p>${feature.properties.Address}<br>${city}, ${state} ${zip}<br>${websiteLink}</p>`)
            .addTo(map);
          return;
        }

        popup.setHTML(`<h3>${name}</h3><p>Loading address...</p>`).addTo(map);

        fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${mapboxgl.accessToken}`)
          .then(response => response.json())
          .then(data => {
            const address = data.features?.[0]?.place_name || 'Address not found';
            popup.setHTML(`<h3>${name}</h3><p>${address}<br>${websiteLink}</p>`);
          })
          .catch(() => {
            popup.setHTML(`<h3>${name}</h3><p>Address unavailable<br>${city}, ${state} ${zip}<br>${websiteLink}</p>`);
          });
      });
    </script>
  </body>
</html>