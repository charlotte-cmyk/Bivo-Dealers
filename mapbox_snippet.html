<div id="map" style="width:100%;height:600px;"></div>

<!-- Mapbox scripts and styles -->
<link
  href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css"
  rel="stylesheet"
/>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>

<style>
  /* Map popup styling */
  .mapboxgl-popup-content {
    background: #103059;
    color: #41D2FA;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
  }
  .mapboxgl-popup-tip {
    border-top-color: #103059 !important;
  }
  .mapboxgl-popup-content h3 {
    margin: 0 0 5px;
    color: #ffffff;
  }
  .mapboxgl-popup-content a {
    color: gold;
    text-decoration: none;
  }
  .mapboxgl-popup-content a:hover {
    text-decoration: underline;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  mapboxgl.accessToken = 'pk.eyJ1IjoiYW5kcmV3c3ViaWUiLCJhIjoiY21oM3ZxNHlyMGNqbTJwcTBrNmxneDd1diJ9._7vjHoFAmx1Ds2zOhXktMQ';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/andrewsubie/cmh9fhjp3001k01qr57ai1k7r',
    center: [-106.5348, 38.7946],
    zoom: 2.4
  });

  map.on('click', (event) => {
    const features = map.queryRenderedFeatures(event.point, {
      layers: ['bivo-dealers-tset (1)']
    });
    if (!features.length) return;

    const feature = features[0];
    if (window.activeDealerPopup) window.activeDealerPopup.remove();
    const [lng, lat] = feature.geometry.coordinates;

    let website = feature.properties.Website;
    if (website && !/^https?:\/\//i.test(website)) website = 'https://' + website;

    const name = feature.properties.name || 'Unnamed Dealer';
    const city = feature.properties.City || '';
    const state = feature.properties.State || '';
    const zip = (feature.properties.Zip || feature.properties['Zip Code'] || '').trim();
    const websiteLink = website
      ? `<a href="${website}" target="_blank" rel="noopener noreferrer">${website}</a>`
      : '';

    const popup = new mapboxgl.Popup({ offset: [0, -15] }).setLngLat([lng, lat]);
    window.activeDealerPopup = popup;

    if (feature.properties.Address) {
      popup.setHTML(`<h3>${name}</h3><p>${feature.properties.Address}<br>${city}, ${state} ${zip}<br>${websiteLink}</p>`).addTo(map);
      return;
    }

    popup.setHTML(`<h3>${name}</h3><p>Loading address...</p>`).addTo(map);
    fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${mapboxgl.accessToken}`)
      .then(response => response.json())
      .then(data => {
        const address = data.features?.[0]?.place_name || 'Address not found';
        popup.setHTML(`<h3>${name}</h3><p>${address}<br>${websiteLink}</p>`);
      })
      .catch(() => {
        popup.setHTML(`<h3>${name}</h3><p>Address unavailable<br>${city}, ${state} ${zip}<br>${websiteLink}</p>`);
      });
  });
});
</script>
